<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dance Master Pro - Ultimate</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; touch-action: manipulation; }
        canvas { width: 100vw; height: 100vh; object-fit: contain; background: #111; display: block; }
        .fade-ui { transition: opacity 0.5s ease; opacity: 0; visibility: hidden; }
        .ui-visible { opacity: 1; visibility: visible; }
        
        .ui-top { position: fixed; top: env(safe-area-inset-top, 10px); width: 100%; display: flex; justify-content: center; gap: 8px; z-index: 100; }
        .ui-bottom { 
            position: fixed; bottom: env(safe-area-inset-bottom, 20px); width: 94%; left: 3%;
            display: flex; flex-direction: column; align-items: center; gap: 8px; z-index: 100; 
            background: rgba(0,0,0,0.75); padding: 12px 0; border-radius: 20px; backdrop-filter: blur(10px);
        }
        
        .mirror-panel { background: rgba(50, 50, 50, 0.8); padding: 8px 15px; border-radius: 12px; display: flex; gap: 10px; font-size: 11px; border: 1px solid #444; align-items: center; flex-wrap: wrap; justify-content: center; }
        #seekBar { width: 90%; height: 25px; accent-color: #007AFF; }
        button { padding: 10px 14px; border-radius: 10px; border: none; font-weight: bold; background: #444; color: white; font-size: 13px; cursor: pointer; }
        button:active { opacity: 0.7; }
        #recordBtn { background: #ff3b30; }
        .recording { background: #900 !important; border: 2px solid #fff; }
        .loop-active { background: #ff9500 !important; }
        .speed-active { background: #34c759 !important; }

        #loginOverlay {
            position: fixed; inset: 0; background: #000; z-index: 9000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        #passInput { padding: 15px; border-radius: 10px; border: none; width: 220px; font-size: 18px; text-align: center; background: #222; color: #fff; border: 1px solid #444; outline: none; }

        #saveContainer { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: #1c1c1e; padding: 20px; border-radius: 25px; z-index: 9500; width: 85%; text-align: center; border: 1px solid #444;
        }
        #previewVid { width: 100%; border-radius: 15px; background: #000; margin-bottom: 15px; max-height: 50vh; }
        
        input[type="range"].small-slider { width: 70px; height: 15px; margin: 0; vertical-align: middle; accent-color: #ffcc00; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h2 style="margin:0; letter-spacing: 2px;">Dance Master Pro</h2>
        <input type="password" id="passInput" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›">
        <button id="entryBtn" style="background:#007AFF; font-size:18px; width:220px; padding:15px;" onclick="checkAccess()">é–‹å§‹</button>
        <p id="errMsg" style="color:#ff3b30; display:none; font-size: 14px;">åˆè¨€è‘‰ãŒé•ã„ã¾ã™</p>
    </div>

    <div id="topPanel" class="ui-top fade-ui">
        <input type="file" id="fileInput" accept="video/*" onchange="loadVideo(event)" style="width:110px;">
        <button onclick="switchLayout()">ğŸ“º è¡¨ç¤ºåˆ‡æ›¿</button>
        <button id="recordBtn" onclick="toggleRecording()">éŒ²ç”»é–‹å§‹</button>
    </div>

    <div id="bottomPanel" class="ui-bottom fade-ui">
        <div class="mirror-panel">
            <label><input type="checkbox" id="mirrorModel" checked> ãŠæ‰‹æœ¬åè»¢</label>
            <label><input type="checkbox" id="mirrorMe" checked> è‡ªåˆ†ã‚’åè»¢</label>
            <button onclick="changeSpeed()" id="btnSpeed" style="padding: 4px 8px; background: #555; min-width: 50px;">x1.0</button>
            <div style="display:flex; align-items:center; gap:5px; margin-left:5px;">
                <span>ğŸ’¡</span>
                <input type="range" id="brightnessRange" class="small-slider" min="100" max="400" value="100">
            </div>
        </div>
        <div id="timeDisplay" style="font-size: 11px; color: #aaa; margin-top:4px;">0s / 0s</div>
        <input type="range" id="seekBar" value="0" step="0.1">
        <div style="display:flex; gap:8px;">
            <button onclick="resetToStart()" style="background:#5856d6;">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            <button onclick="modelVid.currentTime -= 5">âª 5s</button>
            <button id="playPauseBtn" onclick="togglePlay()">â–¶ï¸ å†ç”Ÿ</button>
            <button onclick="modelVid.currentTime += 5">5s â©</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
            <button onclick="setPoint('A')" id="btnA">ğŸ“ A: --</button>
            <button onclick="setPoint('B')" id="btnB">ğŸ“ B: --</button>
            <button onclick="toggleLoop()" id="btnLoop">ğŸ” OFF</button>
        </div>
    </div>

    <div id="saveContainer">
        <h3 style="margin-top:0;">éŒ²ç”»å®Œäº†</h3>
        <video id="previewVid" playsinline controls></video>
        <div style="display:flex; gap:10px;">
            <button onclick="closeSaveUI()" style="background:#555; flex:1;">é–‰ã˜ã‚‹</button>
            <button id="shareBtn" onclick="shareVideo()" style="background:#007AFF; flex:2;">ä¿å­˜ãƒ»å…±æœ‰</button>
        </div>
    </div>

    <canvas id="mainCanvas" onclick="handleCanvasClick()"></canvas>
    <video id="modelVideo" loop playsinline style="display:none;"></video>
    <video id="myCamera" autoplay muted playsinline style="display:none;"></video>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const modelVid = document.getElementById('modelVideo');
        const myCam = document.getElementById('myCamera');
        const seekBar = document.getElementById('seekBar');
        const timeDisplay = document.getElementById('timeDisplay');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const recordBtn = document.getElementById('recordBtn');
        const brightnessRange = document.getElementById('brightnessRange');
        
        let displayMode = 0, mediaRecorder, recordedChunks = [];
        let pointA = 0, pointB = 0, isLooping = false;
        let audioCtx, destination, source, lastBlob;
        let speeds = [1.0, 0.75, 0.5, 0.25];
        let speedIdx = 0;

        canvas.width = 1280; 
        canvas.height = 720;

        async function checkAccess() {
            const pass = document.getElementById('passInput').value;
            if (pass === "dance777") {
                document.getElementById('passInput').blur();
                document.getElementById('loginOverlay').style.display = 'none';
                await initApp();
            } else {
                document.getElementById('errMsg').style.display = 'block';
                document.getElementById('passInput').value = "";
            }
        }

        async function initApp() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                destination = audioCtx.createMediaStreamDestination();
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }, 
                    audio: false 
                });
                myCam.srcObject = stream;
                await myCam.play();

                source = audioCtx.createMediaElementSource(modelVid);
                source.connect(audioCtx.destination);
                source.connect(destination);
                
                showUI();
                render();
            } catch (e) {
                alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Safari/ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function render() {
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const mModel = document.getElementById('mirrorModel').checked;
            const mMe = document.getElementById('mirrorMe').checked;
            
            if (displayMode === 0) {
                draw(modelVid, 0, 0, 640, 720, mModel, 100);
                draw(myCam, 640, 0, 640, 720, mMe, brightnessRange.value);
            } else if (displayMode === 1) {
                draw(modelVid, 0, 0, 1280, 720, mModel, 100);
            } else {
                draw(myCam, 0, 0, 1280, 720, mMe, brightnessRange.value);
            }
            requestAnimationFrame(render);
        }

        function draw(v, x, y, w, h, m, br) {
            if (v.readyState < 2) return; 
            ctx.save();
            
            // æ˜ã‚‹ã•è£œæ­£ï¼ˆbr > 100ã®å ´åˆã¯ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚‚å¼·èª¿ã—ã¦è¦–èªæ€§ã‚’ä¸Šã’ã‚‹ï¼‰
            if (br > 100) {
                const con = 100 + (br - 100) * 0.25; 
                ctx.filter = `brightness(${br}%) contrast(${con}%)`;
            } else {
                ctx.filter = `brightness(${br}%)`;
            }

            if (m) {
                ctx.translate(x + w, y);
                ctx.scale(-1, 1);
                ctx.drawImage(v, 0, 0, w, h);
            } else {
                ctx.drawImage(v, x, y, w, h);
            }
            ctx.restore();
        }

        function loadVideo(e) {
            const f = e.target.files[0];
            if(f) {
                if (modelVid.src) URL.revokeObjectURL(modelVid.src);
                modelVid.src = URL.createObjectURL(f);
                modelVid.load();
                modelVid.onloadedmetadata = () => {
                    seekBar.max = modelVid.duration;
                    pointA = 0;
                    pointB = modelVid.duration;
                    updateTimeDisplay();
                };
            }
        }

        function updateTimeDisplay() {
            const cur = Math.floor(modelVid.currentTime);
            const dur = Math.floor(modelVid.duration || 0);
            timeDisplay.innerText = `${cur}s / ${dur}s`;
        }

        function resetToStart() {
            modelVid.currentTime = pointA;
            if (modelVid.paused) togglePlay();
        }

        function togglePlay() {
            if (modelVid.paused) { 
                modelVid.play(); 
                playPauseBtn.innerText = "â¸ ä¸€æ™‚åœæ­¢"; 
            } else { 
                modelVid.pause(); 
                playPauseBtn.innerText = "â–¶ï¸ å†ç”Ÿ"; 
            }
        }

        function changeSpeed() {
            speedIdx = (speedIdx + 1) % speeds.length;
            const s = speeds[speedIdx];
            modelVid.playbackRate = s;
            const btn = document.getElementById('btnSpeed');
            btn.innerText = `x${s.toFixed(2)}`;
            if (s !== 1.0) btn.classList.add('speed-active');
            else btn.classList.remove('speed-active');
        }

        function setPoint(p) {
            const t = modelVid.currentTime;
            if (p === 'A') { 
                pointA = t; 
                document.getElementById('btnA').innerText = `ğŸ“ A: ${Math.floor(t)}s`; 
            } else { 
                pointB = t; 
                document.getElementById('btnB').innerText = `ğŸ“ B: ${Math.floor(t)}s`; 
            }
        }

        function toggleLoop() {
            isLooping = !isLooping;
            const btn = document.getElementById('btnLoop');
            btn.innerText = isLooping ? "ğŸ” ON" : "ğŸ” OFF";
            if (isLooping) { 
                btn.classList.add('loop-active'); 
                if (modelVid.currentTime < pointA || modelVid.currentTime >= pointB) {
                    modelVid.currentTime = pointA;
                }
                modelVid.play(); 
            } else { 
                btn.classList.remove('loop-active'); 
            }
        }

        function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                recordBtn.innerText = "éŒ²ç”»é–‹å§‹";
                recordBtn.classList.remove('recording');
            } else {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                recordedChunks = [];
                const stream = canvas.captureStream(30);
                const combined = new MediaStream([...stream.getVideoTracks(), ...destination.stream.getAudioTracks()]);
                const mimeType = MediaRecorder.isTypeSupported('video/mp4') ? 'video/mp4' : 'video/webm';
                mediaRecorder = new MediaRecorder(combined, { mimeType: mimeType, videoBitsPerSecond: 3000000 });
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    lastBlob = new Blob(recordedChunks, { type: mimeType });
                    document.getElementById('previewVid').src = URL.createObjectURL(lastBlob);
                    document.getElementById('saveContainer').style.display = 'block';
                };
                mediaRecorder.start(1000); 
                recordBtn.innerText = "åœæ­¢ä¸­";
                recordBtn.classList.add('recording');
            }
        }

        async function shareVideo() {
            if (!lastBlob) return;
            const file = new File([lastBlob], "dance_practice.mp4", { type: "video/mp4" });
            if (navigator.share) {
                try { await navigator.share({ files: [file] }); } catch(e) { downloadFallback(); }
            } else { downloadFallback(); }
        }

        function downloadFallback() {
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(lastBlob); 
            a.download = 'dance_practice.mp4'; 
            a.click();
        }

        modelVid.ontimeupdate = () => {
            if (isLooping && modelVid.currentTime >= pointB) modelVid.currentTime = pointA;
            if (!seekBar.matches(':active')) seekBar.value = modelVid.currentTime;
            updateTimeDisplay();
        };

        function switchLayout() { displayMode = (displayMode + 1) % 3; showUI(); }
        function showUI() { document.querySelectorAll('.fade-ui').forEach(u => u.classList.add('ui-visible')); }
        function handleCanvasClick() {
            if (document.getElementById('topPanel').classList.contains('ui-visible')) {
                document.querySelectorAll('.fade-ui').forEach(u => u.classList.remove('ui-visible'));
            } else {
                showUI();
            }
        }
        function closeSaveUI() { document.getElementById('saveContainer').style.display = 'none'; }
        seekBar.oninput = () => { modelVid.currentTime = seekBar.value; updateTimeDisplay(); };
    </script>
</body>
</html>
