<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dance Master Pro - Mirror Dual</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; touch-action: manipulation; }
        canvas { width: 100vw; height: 100vh; object-fit: contain; background: #111; display: block; }
        .fade-ui { transition: opacity 0.5s ease, visibility 0.5s; opacity: 0; visibility: hidden; }
        .ui-visible { opacity: 1; visibility: visible; }
        
        #countdownOverlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 120px; font-weight: bold; color: #ffcc00; z-index: 5000;
            text-shadow: 0 0 20px rgba(0,0,0,1); pointer-events: none; display: none;
        }

        .ui-top { position: fixed; top: env(safe-area-inset-top, 10px); width: 100%; display: flex; justify-content: center; gap: 8px; z-index: 100; }
        .ui-bottom { 
            position: fixed; bottom: env(safe-area-inset-bottom, 20px); width: 94%; left: 3%;
            display: flex; flex-direction: column; align-items: center; gap: 6px; z-index: 100; 
            background: rgba(0,0,0,0.75); padding: 10px 0; border-radius: 20px; backdrop-filter: blur(10px);
        }
        
        .mirror-panel { background: rgba(50, 50, 50, 0.8); padding: 6px 12px; border-radius: 12px; display: flex; gap: 5px; font-size: 10px; border: 1px solid #444; align-items: center; flex-wrap: wrap; justify-content: center; }
        #seekBar { width: 90%; height: 25px; accent-color: #007AFF; }
        button { padding: 8px 12px; border-radius: 10px; border: none; font-weight: bold; background: #444; color: white; font-size: 12px; }
        
        #recordBtn { background: #ff3b30; min-width: 80px; }
        #recordBtn.is-recording { background: #fff !important; color: #ff3b30; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .active-btn { background: #007AFF !important; }
        .mirror-active { background: #34c759 !important; }

        #loginOverlay {
            position: fixed; inset: 0; background: #000; z-index: 9000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px;
        }
        #passInput { padding: 15px; border-radius: 10px; border: none; width: 220px; font-size: 18px; text-align: center; background: #222; color: #fff; border: 1px solid #444; outline: none; }

        #saveContainer { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: #1c1c1e; padding: 20px; border-radius: 25px; z-index: 9500; width: 85%; text-align: center; border: 1px solid #444;
        }
        #previewVid { width: 100%; border-radius: 15px; background: #000; margin-bottom: 15px; max-height: 50vh; }
        input[type="range"].small-slider { width: 45px; height: 15px; margin: 0; vertical-align: middle; accent-color: #007AFF; }
    </style>
</head>
<body onload="checkDomain()">

    <div id="countdownOverlay"></div>

    <div id="loginOverlay">
        <h2 style="margin:0; letter-spacing: 2px;">Dance Master Pro</h2>
        <input type="password" id="passInput" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›">
        <button id="entryBtn" style="background:#007AFF; font-size:18px; width:220px; padding:15px;" onclick="checkAccess()">é–‹å§‹</button>
        <p id="errMsg" style="color:#ff3b30; display:none; font-size: 14px;">åˆè¨€è‘‰ãŒé•ã„ã¾ã™</p>
    </div>

    <div id="topPanel" class="ui-top fade-ui">
        <input type="file" id="fileInput" accept="video/*" onchange="loadVideo(event)" style="width:105px;">
        <button onclick="switchLayout()">ğŸ“º è¡¨ç¤ºåˆ‡æ›¿</button>
        <button id="recordBtn" onclick="handleRecordClick()">éŒ²ç”»é–‹å§‹</button>
    </div>

    <div id="bottomPanel" class="ui-bottom fade-ui">
        <div class="mirror-panel">
            <button onclick="toggleMirror('model')" id="mirrorModelBtn" class="mirror-active">ğŸªè¦‹æœ¬åè»¢</button>
            <button onclick="toggleMirror('me')" id="mirrorMeBtn" class="mirror-active">ğŸ¤³è‡ªåˆ†åè»¢</button>
            <button onclick="toggleGrid()" id="gridBtn" style="padding: 2px 6px;">#</button>
            <button onclick="changeSpeed()" id="btnSpeed" style="padding: 2px 6px;">x1.0</button>
            <div style="background:#333; padding:2px; border-radius:8px;">
                â³ <button onclick="setCD(3)" id="cd3" class="active-btn" style="padding:2px 4px;">3s</button>
                <button onclick="setCD(5)" id="cd5" style="padding:2px 4px;">5s</button>
                <button onclick="setCD(7)" id="cd7" style="padding:2px 4px;">7s</button>
            </div>
            <div style="display:flex; align-items:center; gap:2px;">
                <span>ğŸ’¡</span><input type="range" id="brightnessRange" class="small-slider" min="100" max="400" value="100">
                <span>ğŸ‘»</span><input type="range" id="ghostRange" class="small-slider" min="0" max="100" value="0">
            </div>
        </div>
        <div id="timeDisplay" style="font-size: 11px; color: #aaa;">0s / 0s</div>
        <input type="range" id="seekBar" value="0" step="0.1">
        <div style="display:flex; gap:6px;">
            <button onclick="startCountdown('reset')" style="background:#5856d6;">ğŸ”„ å¾…æ©Ÿæˆ»ã‚Š</button>
            <button onclick="modelVid.currentTime -= 5">âª 5s</button>
            <button id="playPauseBtn" onclick="togglePlay()">â–¶ï¸ å†ç”Ÿ</button>
            <button onclick="modelVid.currentTime += 5">5s â©</button>
        </div>
        <div style="display:flex; gap:6px; margin-top:4px;">
            <button onclick="setPoint('A')" id="btnA">ğŸ“ A: --</button>
            <button onclick="setPoint('B')" id="btnB">ğŸ“ B: --</button>
            <button onclick="toggleLoop()" id="btnLoop">ğŸ” Loop OFF</button>
        </div>
    </div>

    <div id="saveContainer">
        <h3 style="margin-top:0;">éŒ²ç”»å®Œäº†</h3>
        <video id="previewVid" playsinline controls></video>
        <div style="display:flex; gap:10px;">
            <button onclick="closeSaveUI()" style="background:#555; flex:1;">é–‰ã˜ã‚‹</button>
            <button id="shareBtn" onclick="shareVideo()" style="background:#007AFF; flex:2;">ä¿å­˜ãƒ»å…±æœ‰</button>
        </div>
    </div>

    <canvas id="mainCanvas" onclick="handleCanvasClick()"></canvas>
    <video id="modelVideo" loop playsinline style="display:none;"></video>
    <video id="myCamera" autoplay muted playsinline style="display:none;"></video>

    <script>
        function checkDomain() {
            const allowed = "kunifami-ops.github.io";
            if (window.location.hostname !== allowed) {
                document.body.innerHTML = "<div style='background:#000;color:#ff3b30;height:100vh;display:flex;align-items:center;justify-content:center;font-family:sans-serif;'>Invalid Domain</div>";
                window.stop();
                throw new Error("Access Denied");
            }
        }

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const modelVid = document.getElementById('modelVideo');
        const myCam = document.getElementById('myCamera');
        const seekBar = document.getElementById('seekBar');
        const timeDisplay = document.getElementById('timeDisplay');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const recordBtn = document.getElementById('recordBtn');
        const brightnessRange = document.getElementById('brightnessRange');
        const ghostRange = document.getElementById('ghostRange');
        const cdOverlay = document.getElementById('countdownOverlay');
        
        let displayMode = 0, mediaRecorder = null, recordedChunks = [];
        let pointA = 0, pointB = 0, isLooping = false;
        let audioCtx = null, destination = null, source = null, lastBlob = null;
        let speeds = [1.0, 0.75, 0.5], speedIdx = 0;
        let gridMode = 0, countdownSec = 3, isCountingDown = false;
        let mirrorModel = true, mirrorMe = true;
        let uiTimer = null;

        canvas.width = 1280; canvas.height = 720;

        async function checkAccess() {
            if (document.getElementById('passInput').value === "dance777") {
                document.getElementById('loginOverlay').style.display = 'none';
                await initApp();
            } else { document.getElementById('errMsg').style.display = 'block'; }
        }

        async function initApp() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
                myCam.srcObject = stream; await myCam.play();
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                destination = audioCtx.createMediaStreamDestination();
                source = audioCtx.createMediaElementSource(modelVid);
                source.connect(audioCtx.destination); source.connect(destination);
                showUI(); render();
            } catch (e) { alert("ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚"); }
        }

        function toggleMirror(target) {
            if (target === 'model') {
                mirrorModel = !mirrorModel;
                document.getElementById('mirrorModelBtn').classList.toggle('mirror-active', mirrorModel);
            } else {
                mirrorMe = !mirrorMe;
                document.getElementById('mirrorMeBtn').classList.toggle('mirror-active', mirrorMe);
            }
            resetUITimer();
        }

        function render() {
            ctx.fillStyle = "#111"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            const br = brightnessRange.value;
            const ghostOpacity = ghostRange.value / 100;
            if (displayMode === 0) {
                draw(modelVid, 0, 0, 640, 720, mirrorModel, 100, 1);
                draw(myCam, 640, 0, 640, 720, mirrorMe, br, 1);
                if (ghostOpacity > 0) draw(modelVid, 640, 0, 640, 720, mirrorModel, 100, ghostOpacity);
            } else if (displayMode === 1) {
                draw(modelVid, 0, 0, 1280, 720, mirrorModel, 100, 1);
            } else {
                draw(myCam, 0, 0, 1280, 720, mirrorMe, br, 1);
                if (ghostOpacity > 0) draw(modelVid, 0, 0, 1280, 720, mirrorModel, 100, ghostOpacity);
            }
            if (gridMode > 0) {
                ctx.save(); ctx.strokeStyle = "rgba(0, 255, 255, 0.4)"; ctx.lineWidth = 2; ctx.beginPath();
                if (gridMode === 1) { ctx.moveTo(640, 0); ctx.lineTo(640, 720); ctx.moveTo(0, 360); ctx.lineTo(1280, 360); }
                else { for(let x=160; x<1280; x+=160) { ctx.moveTo(x, 0); ctx.lineTo(x, 720); } for(let y=90; y<720; y+=90) { ctx.moveTo(0, y); ctx.lineTo(1280, y); } }
                ctx.stroke(); ctx.restore();
            }
            requestAnimationFrame(render);
        }

        function draw(v, x, y, w, h, mirror, br, alpha) {
            if (v.readyState < 2) return; 
            ctx.save(); ctx.globalAlpha = alpha;
            const con = br > 100 ? 100 + (br - 100) * 0.25 : 100;
            ctx.filter = `brightness(${br}%) contrast(${con}%)`;
            if (mirror) { ctx.translate(x + w, y); ctx.scale(-1, 1); ctx.drawImage(v, 0, 0, w, h); }
            else { ctx.drawImage(v, x, y, w, h); }
            ctx.restore();
        }

        function setCD(s) { 
            countdownSec = s; 
            [3, 5, 7].forEach(v => {
                const btn = document.getElementById(`cd${v}`);
                if (btn) btn.classList.toggle('active-btn', v === s);
            }); 
            resetUITimer(); 
        }
        
        function handleRecordClick() { 
            if (mediaRecorder && mediaRecorder.state === "recording") {
                stopRecording();
            } else if (!isCountingDown) {
                startCountdown('record'); 
            }
            resetUITimer();
        }

        function startCountdown(type) {
            isCountingDown = true; hideUI();
            let count = countdownSec; cdOverlay.style.display = 'block'; cdOverlay.innerText = count; modelVid.pause
